name: DevSecOps Assets Pipeline

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - 'README.md'
      - 'infra/**'

jobs:
  build-secure-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: TruffleHog Secret Scan
        id: trufflehog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ""
          head: HEAD
          extra_args: --debug --no-verification

      - name: ‚ò¢Ô∏è Email Alerte Secret
        if: failure() && steps.trufflehog.outcome == 'failure'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "‚ò¢Ô∏è ALERTE : Secret D√©tect√© (DevSecOps)"
          to: eliraouisoumia2003@gmail.com
          from: DevSecOps Bot <soumia@gmail.com>
          body: "Secret trouv√© ! D√©ploiement annul√©."

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build and Push
        id: docker_build
        uses: docker/build-push-action@v4
        with:
          context: ./app
          push: true
          # üëá NOUVEAU NOM IMAGE
          tags: ${{ secrets.DOCKER_USERNAME }}/devsecops-assets:latest
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/devsecops-assets:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/devsecops-assets:buildcache,mode=max

      - name: üî¥ Email √âchec Build
        if: failure() && steps.docker_build.outcome == 'failure'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "üî¥ √âCHEC : Build Docker (DevSecOps)"
          to: eliraouisoumia2003@gmail.com
          from: DevSecOps Bot <soumia@gmail.com>
          body: "Le build Docker a √©chou√©."

      - name: Run Trivy scanner
        id: trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ secrets.DOCKER_USERNAME }}/devsecops-assets:latest'
          format: 'table'
          exit-code: '1' 
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL'

      - name: üõ°Ô∏è Email Alerte Trivy
        if: failure() && steps.trivy.outcome == 'failure'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "üõ°Ô∏è ALERTE : Faille Critique (DevSecOps)"
          to: eliraouisoumia2003@gmail.com
          from: DevSecOps Bot <soumia@gmail.com>
          body: "Vuln√©rabilit√© critique trouv√©e. D√©ploiement bloqu√©."

  deploy:
    needs: build-secure-push
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        id: deploy_ssh
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          envs: DOCKER_USERNAME 
          script: |
            # üëá NOUVEAUX NOMS CONTENEURS
            sudo docker pull ${{ secrets.DOCKER_USERNAME }}/devsecops-assets:latest
            sudo docker stop devsecops-app || true
            sudo docker rm devsecops-app || true
            sudo docker run -d -p 80:80 --name devsecops-app ${{ secrets.DOCKER_USERNAME }}/devsecops-assets:latest

      # üö® CAS D'√âCHEC
      - name: üî¥ Email √âchec D√©ploiement
        if: failure() && steps.deploy_ssh.outcome == 'failure'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "üî¥ √âCHEC : D√©ploiement (DevSecOps)"
          to: soumiaeliraoui2003@gmail.com
          from: DevSecOps Bot <eliraouisoumia2003@gmail.com>
          body: "Impossible de contacter le serveur EC2."

      # ‚úÖ CAS DE SUCC√àS (NOUVEAU)
      - name: ‚úÖ Email Succ√®s D√©ploiement
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "‚úÖ SUCC√àS : D√©ploiement R√©ussi (DevSecOps)"
          to: soumiaeliraoui2003@gmail.com
          from: DevSecOps Bot <soumia@gmail.com>
          body: |
            F√©licitations ! üöÄ
            
            Le pipeline DevSecOps est pass√© au vert :
            1. Secrets : OK (TruffleHog)
            2. Build Docker : OK
            3. Scan Vuln√©rabilit√©s : OK (Trivy)
            4. D√©ploiement EC2 : OK
            
            La nouvelle version est en ligne sur votre serveur.