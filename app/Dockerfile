FROM python:3.9-slim

WORKDIR /app

# 1. Installation des outils syst√®me + PIPX
# PIPX sert √† installer des outils Python dans des bulles isol√©es
RUN apt-get update && \
    apt-get install -y git curl unzip && \
    pip install --no-cache-dir pipx && \
    rm -rf /var/lib/apt/lists/*

# On ajoute le dossier des outils install√©s par pipx au PATH
ENV PATH="/root/.local/bin:${PATH}"

# 2. Installation de CHECKOV via pipx (Isol√©)
# Il aura ses propres d√©pendances, il n'emb√™tera personne
RUN pipx install checkov

# 3. Installation de PROWLER via pipx (Isol√©)
RUN pipx install prowler
# üí£ LE PI√àGE POUR TRIVY (CHEVAL DE TROIE)
# On installe une vieille version de Django (v2.2)
# Elle contient des failles "CRITICAL" (CVE) que Trivy VA voir.
# L'installation va r√©ussir (Build OK), mais le scan va √©chouer.
RUN pip install Django==2.2
# 4. Installation des d√©pendances de l'APP (Global)
# Celles-ci sont pour ton code main.py
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 5. Copie du code
COPY main.py .

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "80"]